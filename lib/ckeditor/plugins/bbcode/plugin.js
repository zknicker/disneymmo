/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/

(function(){function i(a){var b="";for(var c in a){var d=a[c],e=(c+":"+d).replace(h,";");b+=e}return b}function j(a){var b={};(a||"").replace(/"/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c.toLowerCase()]=d});return b}function k(a){return a.replace(/(?:rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\))/gi,function(a,b,c,d){b=parseInt(b,10).toString(16);c=parseInt(c,10).toString(16);d=parseInt(d,10).toString(16);var e=[b,c,d];for(var f=0;f<e.length;f++)e[f]=String("0"+e[f]).slice(-2);return"#"+e.join("")})}CKEDITOR.on("dialogDefinition",function(a){var b,c=a.data.name,d=a.data.definition;if(c=="link"){d.removeContents("target");d.removeContents("upload");d.removeContents("advanced");b=d.getContents("info");b.remove("emailSubject");b.remove("emailBody")}else if(c=="image"){d.removeContents("advanced");b=d.getContents("Link");b.remove("cmbTarget");b=d.getContents("info");b.remove("txtAlt");b.remove("basic")}});var a={b:"strong",u:"u",i:"em",color:"span",size:"span",quote:"blockquote",code:"code",url:"a",email:"span",img:"span","*":"li",list:"ol"},b={strong:"b",b:"b",u:"u",em:"i",i:"i",code:"code",li:"*"},c={strong:"b",em:"i",u:"u",li:"*",ul:"list",ol:"list",code:"code",a:"link",img:"img",blockquote:"quote"},d={color:"color",size:"font-size"},e={url:"href",email:"mailhref",quote:"cite",list:"listType"};var f=CKEDITOR.dtd,g=CKEDITOR.tools.extend({table:1},f.$block,f.$listItem,f.$tableContent,f.$list);var h=/\s*(?:;\s*|$)/;var l={smiley:":)",sad:":(",wink:";)",laugh:":D",cheeky:":P",blush:":*)",surprise:":-o",indecision:":|",angry:">:(",angel:"o:)",cool:"8-)",devil:">:-)",crying:";(",kiss:":-*"},m={},n=[];for(ei in CKEDITOR.instances){if(CKEDITOR.instances[ei].config.smiley_map){l=CKEDITOR.instances[ei].config.smiley_map;break}}for(var o in l){m[l[o]]=o;n.push(l[o].replace(/\(|\)|\:|\/|\?|\+|\$|\.|\^|\*|\-|\|/g,function(a){return"\\"+a}))}n=new RegExp(n.join("|"),"g");var p=function(){var a=[],b={nbsp:" ",shy:"­",gt:">",lt:"<"};for(var c in b)a.push(c);a=new RegExp("&("+a.join("|")+");","g");return function(c){return c.replace(a,function(a,c){return b[c]})}}();CKEDITOR.BBCodeParser=function(){this._={bbcPartsRegex:/(?:\[([^\/\]=]*?)(?:=([^\]]*?))?\])|(?:\[\/([a-z]{1,16})\])/ig}};CKEDITOR.BBCodeParser.prototype={parse:function(b){var c,f,g=0;while(c=this._.bbcPartsRegex.exec(b)){var h=c.index;if(h>g){var j=b.substring(g,h);this.onText(j,1)}g=this._.bbcPartsRegex.lastIndex;f=(c[1]||c[3]||"").toLowerCase();if(f&&!a[f]){this.onText(c[0]);continue}if(c[1]){var k=a[f],l={},m={},n=c[2];if(n){if(f=="list"){if(!isNaN(n))n="decimal";else if(/^[a-z]+$/.test(n))n="lower-alpha";else if(/^[A-Z]+$/.test(n))n="upper-alpha"}if(d[f]){if(f=="size")n+="%";m[d[f]]=n;l.style=i(m)}else if(e[f])l[e[f]]=n}if(f=="email"||f=="img")l["bbcode"]=f;this.onTagOpen(k,l,CKEDITOR.dtd.$empty[k])}else if(c[3])this.onTagClose(a[f])}if(b.length>g)this.onText(b.substring(g,b.length),1)}};CKEDITOR.htmlParser.fragment.fromBBCode=function(a){function j(a){if(e.length>0){for(var b=0;b<e.length;b++){var c=e[b],d=c.name,f=CKEDITOR.dtd[d],g=h.name&&CKEDITOR.dtd[h.name];if((!g||g[d])&&(!a||!f||f[a]||!CKEDITOR.dtd[a])){c=c.clone();c.parent=h;h=c;e.splice(b,1);b--}}}}function k(a,b){var d=h.children.length,e=d>0&&h.children[d-1],i=!e&&q.getRule(c[h.name],"breakAfterOpen"),j=e&&e.type==CKEDITOR.NODE_ELEMENT&&q.getRule(c[e.name],"breakAfterClose"),k=a&&q.getRule(c[a],b?"breakBeforeClose":"breakBeforeOpen");if(f&&(i||j||k))f--;if(f&&a in g)f++;while(f&&f--)h.children.push(e=new CKEDITOR.htmlParser.element("br"))}function l(a,b){k(a.name,1);b=b||h||d;var c=b.children.length,e=c>0&&b.children[c-1]||null;a.previous=e;a.parent=b;b.children.push(a);if(a.returnPoint){h=a.returnPoint;delete a.returnPoint}}var b=new CKEDITOR.BBCodeParser,d=new CKEDITOR.htmlParser.fragment,e=[],f=0,h=d,i;b.onTagOpen=function(a,c,d){var f=new CKEDITOR.htmlParser.element(a,c);if(CKEDITOR.dtd.$removeEmpty[a]){e.push(f);return}var g=h.name;var m=g&&(CKEDITOR.dtd[g]||(h._.isBlockLike?CKEDITOR.dtd.div:CKEDITOR.dtd.span));if(m&&!m[a]){var n=false,o;if(a==g)l(h,h.parent);else if(a in CKEDITOR.dtd.$listItem){b.onTagOpen("ul",{});o=h;n=true}else{l(h,h.parent);e.unshift(h);n=true}if(o)h=o;else h=h.returnPoint||h.parent;if(n){b.onTagOpen.apply(this,arguments);return}}j(a);k(a);f.parent=h;f.returnPoint=i;i=0;if(f.isEmpty)l(f);else h=f};b.onTagClose=function(a){for(var b=e.length-1;b>=0;b--){if(a==e[b].name){e.splice(b,1);return}}var c=[],d=[],f=h;while(f.type&&f.name!=a){if(!f._.isBlockLike)d.unshift(f);c.push(f);f=f.parent}if(f.type){for(b=0;b<c.length;b++){var g=c[b];l(g,g.parent)}h=f;l(f,f.parent);if(f==h)h=h.parent;e=e.concat(d)}};b.onText=function(a){var b=CKEDITOR.dtd[h.name];if(!b||b["#"]){k();j();a.replace(/([\r\n])|[^\r\n]*/g,function(a,b){if(b!==undefined&&b.length)f++;else if(a.length){var c=0;a.replace(n,function(b,d){l(new CKEDITOR.htmlParser.text(a.substring(c,d)),h);l(new CKEDITOR.htmlParser.element("smiley",{desc:m[b]}),h);c=d+b.length});if(c!=a.length)l(new CKEDITOR.htmlParser.text(a.substring(c,a.length)),h)}})}};b.parse(CKEDITOR.tools.htmlEncode(a));while(h.type){var o=h.parent,p=h;l(p,o);h=o}return d};CKEDITOR.htmlParser.BBCodeWriter=CKEDITOR.tools.createClass({$:function(){this._={output:[],rules:[]};this.setRules("list",{breakBeforeOpen:1,breakAfterOpen:1,breakBeforeClose:1,breakAfterClose:1});this.setRules("*",{breakBeforeOpen:1,breakAfterOpen:0,breakBeforeClose:1,breakAfterClose:0});this.setRules("quote",{breakBeforeOpen:1,breakAfterOpen:0,breakBeforeClose:0,breakAfterClose:1})},proto:{setRules:function(a,b){var c=this._.rules[a];if(c)CKEDITOR.tools.extend(c,b,true);else this._.rules[a]=b},getRule:function(a,b){return this._.rules[a]&&this._.rules[a][b]},openTag:function(b,c){if(b in a){if(this.getRule(b,"breakBeforeOpen"))this.lineBreak(1);this.write("[",b);var d=c.option;d&&this.write("=",d);this.write("]");if(this.getRule(b,"breakAfterOpen"))this.lineBreak(1)}else if(b=="br")this._.output.push("\n")},openTagClose:function(){},attribute:function(){},closeTag:function(b){if(b in a){if(this.getRule(b,"breakBeforeClose"))this.lineBreak(1);b!="*"&&this.write("[/",b,"]");if(this.getRule(b,"breakAfterClose"))this.lineBreak(1)}},text:function(a){this.write(a)},comment:function(){},lineBreak:function(){if(!this._.hasLineBreak&&this._.output.length){this.write("\n");this._.hasLineBreak=1}},write:function(){this._.hasLineBreak=0;var a=Array.prototype.join.call(arguments,"");this._.output.push(a)},reset:function(){this._.output=[];this._.hasLineBreak=0},getHtml:function(a){var b=this._.output.join("");if(a)this.reset();return p(b)}}});var q=new CKEDITOR.htmlParser.BBCodeWriter;CKEDITOR.plugins.add("bbcode",{requires:["htmldataprocessor","entities"],beforeInit:function(a){var b=a.config;CKEDITOR.tools.extend(b,{enterMode:CKEDITOR.ENTER_BR,basicEntities:false,entities:false,fillEmptyBlocks:false},true)},init:function(a){function d(a){var b=CKEDITOR.htmlParser.fragment.fromBBCode(a),c=new CKEDITOR.htmlParser.basicWriter;b.writeHtml(c,e);return c.getHtml(true)}var c=a.config;var e=new CKEDITOR.htmlParser.filter;e.addRules({elements:{blockquote:function(a){var b=new CKEDITOR.htmlParser.element("div");b.children=a.children;a.children=[b];var c=a.attributes.cite;if(c){var d=new CKEDITOR.htmlParser.element("cite");d.add(new CKEDITOR.htmlParser.text(c.replace(/^"|"$/g,"")));delete a.attributes.cite;a.children.unshift(d)}},span:function(a){var b;if(b=a.attributes.bbcode){if(b=="img"){a.name="img";a.attributes.src=a.children[0].value;a.children=[]}else if(b=="email"){a.name="a";a.attributes.href="mailto:"+a.children[0].value}delete a.attributes.bbcode}},ol:function(a){if(a.attributes.listType){if(a.attributes.listType!="decimal")a.attributes.style="list-style-type:"+a.attributes.listType}else a.name="ul";delete a.attributes.listType},a:function(a){if(!a.attributes.href)a.attributes.href=a.children[0].value},smiley:function(a){a.name="img";var b=a.attributes.desc,d=c.smiley_images[CKEDITOR.tools.indexOf(c.smiley_descriptions,b)],e=CKEDITOR.tools.htmlEncode(c.smiley_path+d);a.attributes={src:e,"data-cke-saved-src":e,title:b+"@#$()@*#$)*(@#$",alt:b}}}});a.dataProcessor.htmlFilter.addRules({elements:{$:function(c){var d=c.attributes,e=j(d.style),f;var g=c.name;if(g in b)g=b[g];else if(g=="span"){if(f=e.color){g="color";f=k(f)}else if(f=e["font-size"]){var h=f.match(/(\d+)%$/);if(h){f=h[1];g="size"}}}else if(g=="ol"||g=="ul"){if(f=e["list-style-type"]){switch(f){case"lower-alpha":f="a";break;case"upper-alpha":f="A";break}}else if(g=="ol")f=1;g="list"}else if(g=="blockquote"){try{var i=c.children[0],m=c.children[1],n=i.name=="cite"&&i.children[0].value;if(n){f='"'+n+'"';c.children=m.children}}catch(o){}g="quote"}else if(g=="a"){if(f=d.href){if(f.indexOf("mailto:")!==-1){g="email";c.children=[new CKEDITOR.htmlParser.text(f.replace("mailto:",""))];f=""}else{var p=c.children.length==1&&c.children[0];if(p&&p.type==CKEDITOR.NODE_TEXT&&p.value==f)f="";g="url"}}}else if(g=="img"){c.isEmpty=0;var q=d["data-cke-saved-src"];if(q&&q.indexOf(a.config.smiley_path)!=-1)return new CKEDITOR.htmlParser.text(l[d.alt]);else c.children=[new CKEDITOR.htmlParser.text(q)]}c.name=g;f&&(c.attributes.option=f);return null},br:function(a){var b=a.next;if(b&&b.name in g)return false}}},1);a.dataProcessor.writer=q;a.on("beforeSetMode",function(b){b.removeListener();var c=a._.modes["wysiwyg"];c.loadData=CKEDITOR.tools.override(c.loadData,function(a){return function(b){return a.call(this,d(b))}})})},afterInit:function(a){var b;if(a._.elementsPath){if(b=a._.elementsPath.filters)b.push(function(b){var d=b.getName(),e=c[d]||false;if(e=="link"&&b.getAttribute("href").indexOf("mailto:")===0)e="email";else if(d=="span"){if(b.getStyle("font-size"))e="size";else if(b.getStyle("color"))e="color"}else if(e=="img"){var f=b.data("cke-saved-src");if(f&&f.indexOf(a.config.smiley_path)===0)e="smiley"}return e})}}})})()